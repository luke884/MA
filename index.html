<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å‡ç·šå›æ¸¬ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #1e293b;
            --secondary: #64748b;
            --accent: #0ea5e9;
            --accent-dark: #0284c7;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-light: #f8fafc;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
            color: var(--primary);
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            padding: 40px;
        }
        
        /* æ¨¡å¼é¸æ“‡å™¨ */
        .mode-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        .mode-btn {
            padding: 10px 20px;
            background: var(--bg-light);
            color: var(--secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .mode-btn:hover {
            background: #f1f5f9;
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .mode-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent-dark);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        /* æ¨™é¡Œ */
        h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
        }
        
        /* è¼¸å…¥å€åŸŸ */
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
            padding: 24px;
            background: var(--bg-light);
            border-radius: 12px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            font-size: 13px;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select {
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: var(--primary);
            transition: all 0.2s;
            font-family: inherit;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        input:hover, select:hover {
            border-color: var(--secondary);
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
            grid-column: span 2;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* é€²åº¦æ¢ */
        .progress-wrapper {
            display: none;
            margin: 24px 0;
            padding: 16px;
            background: var(--bg-light);
            border-radius: 8px;
        }
        
        #progLabel {
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary);
            display: block;
            margin-bottom: 12px;
        }
        
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--accent) 100%);
            width: 0%;
            transition: width 0.2s;
        }
        
        /* å¿«é€ŸæŸ¥è©¢å€ */
        #querySection {
            background: white;
            padding: 32px 40px !important;
            border-radius: 16px !important;
            border: 2px solid #0ea5e9 !important;
            margin-bottom: 32px !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            display: block;
        }
        
        #querySection.hidden {
            display: none;
        }
        
        #querySection h3 {
            color: #1e293b;
            margin-bottom: 24px;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #querySection .query-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: flex-end;
        }
        
        #querySection .input-group {
            margin-bottom: 0;
        }
        
        #querySection .input-group label {
            color: #475569;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        #querySection input {
            border: 1px solid #cbd5e1;
            background: white;
            color: #1e293b;
            padding: 12px 16px;
            font-size: 15px;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #querySection input::placeholder {
            color: #94a3b8;
        }
        
        #querySection input:focus {
            outline: none;
            border-color: #0ea5e9;
            background: white;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        #querySection input:hover {
            border-color: #0ea5e9;
        }
        
        #querySection button {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%) !important;
            color: white !important;
            padding: 12px 32px !important;
            font-weight: 700 !important;
            border: none !important;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3) !important;
            border-radius: 8px !important;
            font-size: 15px !important;
        }
        
        #querySection button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(14, 165, 233, 0.4) !important;
        }
        
        #querySection button:active {
            transform: translateY(0);
        }
        
        #queryResult {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            padding: 12px 16px;
            min-height: 40px;
            display: flex;
            align-items: center;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bae6fd;
            word-break: break-word;
        }
        
        #queryResult span {
            display: block;
        }
        
        /* æŸ¥è©¢æ¨¡å¼åˆ‡æ› */
        .query-mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .query-mode-tab {
            padding: 10px 20px;
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .query-mode-tab:hover {
            background: #e0f2fe;
            border-color: #0ea5e9;
            color: #0284c7;
        }
        
        .query-mode-tab.active {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-color: #0284c7;
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }
        
        /* æ‰¹é‡æŸ¥è©¢å®¹å™¨ */
        .batch-query-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .batch-query-input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        #batchQueryInput {
            width: 100%;
            height: 150px;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
            color: white;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        
        #batchQueryInput:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
        }
        
        #batchQueryInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .batch-query-result {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        #batchQueryResult {
            max-height: 180px;
            overflow-y: auto;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
            line-height: 1.6;
            color: #dbeafe;
            font-family: 'Courier New', monospace;
        }
        
        .batch-result-item {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .batch-result-item:last-child {
            border-bottom: none;
        }
        
        .batch-success {
            color: #86efac;
        }
        
        .batch-error {
            color: #fca5a5;
        }
        
        .batch-query-button {
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .batch-query-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* çµæœç¶²æ ¼ */
        .results-grid {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 24px;
            margin-top: 30px;
        }
        
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, var(--bg-light) 0%, #f1f5f9 100%);
            padding: 24px;
            border-radius: 12px;
            border-left: 4px solid var(--accent);
            box-shadow: var(--shadow);
        }
        
        .stats-card h3 {
            margin-bottom: 16px;
            color: var(--primary);
        }
        
        .stats-card p {
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stats-card p strong {
            color: var(--primary);
            font-weight: 600;
        }
        
        /* æ’åè¡¨ */
        .rank-table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .rank-table-wrapper::-webkit-scrollbar {
            width: 6px;
        }
        
        .rank-table-wrapper::-webkit-scrollbar-track {
            background: var(--bg-light);
            border-radius: 4px;
        }
        
        .rank-table-wrapper::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }
        
        .rank-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background: linear-gradient(135deg, var(--bg-light) 0%, #f1f5f9 100%);
            padding: 14px 12px;
            text-align: center;
            font-weight: 600;
            color: var(--secondary);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 14px 12px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            color: var(--secondary);
        }
        
        #topTable tbody tr {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #topTable tbody tr:hover {
            background: var(--bg-light);
            color: var(--accent);
        }
        
        #topTable tbody tr.selected {
            background: rgba(14, 165, 233, 0.1);
            color: var(--accent);
            font-weight: 600;
        }
        
        /* äº¤æ˜“è¡¨ */
        .trade-table-wrapper {
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 12px;
            box-shadow: var(--shadow);
        }
        
        .buy-text {
            color: var(--success);
            font-weight: 600;
        }
        
        .sell-text {
            color: var(--danger);
            font-weight: 600;
        }
        
        .final-text {
            color: var(--warning);
            font-weight: 600;
            font-style: italic;
        }
        
        /* åœ–è¡¨ */
        #chartContainer {
            width: 100%;
            height: 500px;
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-light);
            border-radius: 12px;
        }
        
        /* 2D/3D åœ–è¡¨ */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 24px;
        }
        
        .chart-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--accent);
        }
        
        #scatter2dChart, #canvas3d {
            width: 100%;
            height: 500px;
            display: block;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1024px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 24px;
            }
        }
        
        @media (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
            }
            
            button {
                grid-column: span 1;
            }
            
            .mode-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="mode-selector">
        <button class="mode-btn active" onclick="switchMode('SMA')">SMA ç°¡å–®å‡ç·š</button>
        <button class="mode-btn" onclick="switchMode('WMA')">WMA åŠ æ¬Šå‡ç·š</button>
        <button class="mode-btn" onclick="switchMode('EMA')">EMA æŒ‡æ•¸å‡ç·š</button>
    </div>
    
    <h1 id="pageTitle">SMA å‡ç·šå›æ¸¬ç³»çµ±</h1>

    <div class="input-section">
        <div class="input-group"><label>åˆå§‹è³‡é‡‘</label><input id="initialCash" type="number" value="10000"></div>
        <div class="input-group"><label>é¸æ“‡å…¬å¸</label><select id="companySelect"><option>è«‹å…ˆä¸Šå‚³ CSV</option></select></div>
        <div class="input-group"><label>èµ·å§‹æ—¥æœŸ</label><input id="startDate" type="date" value="2024-01-01"></div>
        <div class="input-group"><label>çµæŸæ—¥æœŸ</label><input id="endDate" type="date" value="2024-12-31"></div>
        <div class="input-group"><label>æ‰‹çºŒè²» (%)</label><input id="commission" type="number" value="0.08" step="0.01"></div>
        <div class="input-group" style="grid-column: span 2;"><label>ä¸Šå‚³ CSV æª”æ¡ˆ</label><input id="csvFile" type="file" accept=".csv"></div>
        <button id="runBtn" onclick="runOptimization()">é–‹å§‹å…¨åƒæ•¸æœ€ä½³åŒ–</button>
    </div>

    <div id="querySection">
        <h3>ğŸ¯ å¿«é€ŸæŸ¥è©¢çµ„åˆæ’å</h3>
        
        <!-- æ¨¡å¼åˆ‡æ›æ¨™ç±¤ -->
        <div class="query-mode-tabs">
            <button class="query-mode-tab active" onclick="switchQueryMode('single')">ğŸ“ å–®å€‹æŸ¥è©¢</button>
            <button class="query-mode-tab" onclick="switchQueryMode('batch')">ğŸ“‹ æ‰¹é‡æŸ¥è©¢</button>
        </div>
        
        <!-- å–®å€‹æŸ¥è©¢æ¨¡å¼ -->
        <div id="singleQueryMode" class="query-mode-content">
            <div class="query-container">
                <div class="input-group">
                    <label>è¼¸å…¥çµ„åˆ (çŸ­/é•·)</label>
                    <input id="queryInput" type="text" placeholder="ä¾‹ï¼š5/20" value="">
                </div>
                <button onclick="quickQuery()">æŸ¥è©¢</button>
                <div id="queryResult"></div>
            </div>
        </div>
        
        <!-- æ‰¹é‡æŸ¥è©¢æ¨¡å¼ -->
        <div id="batchQueryMode" class="query-mode-content" style="display: none;">
            <div class="batch-query-container">
                <div class="batch-query-input-area">
                    <label style="color: rgba(255, 255, 255, 0.9); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">æ‰¹é‡è¼¸å…¥ (æ¯è¡Œä¸€å€‹çµ„åˆ)</label>
                    <textarea id="batchQueryInput" placeholder="5/20&#10;10/30&#10;3/15&#10;7/25"></textarea>
                </div>
                <div class="batch-query-result">
                    <button onclick="batchQuery()" class="batch-query-button">æ‰¹é‡æŸ¥è©¢</button>
                    <div id="batchQueryResult"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="progress-wrapper" id="progWrapper">
        <label id="progLabel">è¨ˆç®—é€²åº¦...</label>
        <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>
    </div>

    <div class="results-grid">
        <div class="side-panel">
            <div id="bestResult" class="stats-card">å°šæœªåŸ·è¡Œ</div>
            <h3>ğŸ† æ’è¡Œæ¦œ</h3>
            <div class="rank-table-wrapper">
                <table id="topTable">
                    <thead><tr><th>æ’å</th><th>çŸ­/é•·</th><th>äº¤æ˜“ç­†æ•¸</th><th>æœ€çµ‚è³‡ç”¢</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div>
            <div id="chartContainer"><canvas id="mainChart"></canvas></div>
            <h3 id="tableTitle">ğŸ“‘ äº¤æ˜“æ˜ç´°</h3>
            <div class="trade-table-wrapper">
                <table id="tradeTable">
                    <thead><tr><th>æ—¥æœŸ</th><th>å‹•ä½œ</th><th>åƒ¹æ ¼</th><th>è‚¡æ•¸</th><th>ç²åˆ©</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢ï¼š2D å’Œ 3D åœ–è¡¨ -->
    <div class="chart-grid" id="chartGrid" style="display: none;">
        <div class="chart-card">
            <div class="chart-title">ğŸ“Š 2D ç†±åŠ›åœ– - åƒæ•¸èˆ‡ç²åˆ©</div>
            <div id="scatter2dChart"></div>
        </div>
        <div class="chart-card">
            <div class="chart-title">ğŸ® 3D è¡¨é¢åœ– - åƒæ•¸å„ªåŒ–ç©ºé–“</div>
            <div id="canvas3d"></div>
        </div>
    </div>
</div>

<script>
    let g_backtestData = [], g_allMA = {}, g_startIdx = 0, g_initialCash = 0, g_commission = 0, chartInstance = null;
    let g_currentMode = 'SMA';
    let g_allResults = []; // å­˜å‚¨æ‰€æœ‰ä¼˜åŒ–ç»“æœç”¨äºç»˜å›¾
    let g_rankedResults = []; // å­˜å‚¨æ’åºåçš„æ‰€æœ‰ç»“æœç”¨äºå¿«é€ŸæŸ¥è¯¢
    const MAX_PERIOD = 256;

    function switchMode(mode) {
        g_currentMode = mode;
        const title = mode === 'SMA' ? 'SMA å‡ç·šå›æ¸¬ç³»çµ±' : (mode === 'WMA' ? 'WMA å‡ç·šå›æ¸¬ç³»çµ±' : 'EMA å‡ç·šå›æ¸¬ç³»çµ±');
        document.getElementById('pageTitle').innerText = title;
        
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.getElementById('bestResult').innerHTML = 'å°šæœªåŸ·è¡Œ';
        document.querySelector("#topTable tbody").innerHTML = '';
        document.querySelector("#tradeTable tbody").innerHTML = '';
        if (chartInstance) chartInstance.destroy();
        document.getElementById('chartGrid').style.display = 'none';
        g_allMA = {};
        document.getElementById('querySection').classList.add('hidden');
        document.getElementById('queryResult').innerHTML = '';
    }

    function formatCurrency(num) {
        return num.toLocaleString('zh-TW', { minimumFractionDigits: 10, maximumFractionDigits: 10 });
    }

    function dateToInt(dStr) {
        if (!dStr) return 0;
        const parts = dStr.includes('-') ? dStr.split('-') : dStr.split('/');
        if (parts.length !== 3) return 0;
        const [y, m, d] = dStr.includes('-') ? parts : [parts[2], parts[0], parts[1]];
        return parseInt(y + m.padStart(2, '0') + d.padStart(2, '0'));
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const lines = event.target.result.trim().split("\n");
            window.csvHeaders = lines[0].split(",").map(h => h.trim());
            window.csvRaw = lines.slice(1).map(line => line.split(","));
            document.getElementById("companySelect").innerHTML = window.csvHeaders.slice(1).map(h => `<option value="${h}">${h}</option>`).join('');
        };
        reader.readAsText(e.target.files[0]);
    });

    function precomputeSMA(data, period) {
        let sma = [], sum = 0;
        for (let i = 0; i < data.length; i++) {
            sum += data[i].close;
            if (i >= period) sum -= data[i - period].close;
            sma.push(i >= period - 1 ? sum / period : null);
        }
        return sma;
    }

    function precomputeWMA(data, period) {
        const res = [];
        const denominator = (period * (period + 1)) / 2;
        for(let i = 0; i < data.length; i++){
            if(i < period - 1){ 
                res.push(null); 
                continue; 
            }
            let sum = 0;
            for(let j = 0; j < period; j++){
                sum += data[i - period + 1 + j].close * (j + 1);
            }
            res.push(sum / denominator);
        }
        return res;
    }

    // æ¨™æº– SMA å‡½æ•¸ - è™•ç†æ•¸å€¼æ•¸çµ„
    function SMA(arr, period){
        const res = [];
        let sum = 0;
        for(let i = 0; i < arr.length; i++){
            sum += arr[i];
            if(i >= period) sum -= arr[i - period];
            res.push(i >= period - 1 ? sum / period : null);
        }
        return res;
    }

    // æ¨™æº– EMA å‡½æ•¸ - è™•ç†æ•¸å€¼æ•¸çµ„
    function EMA(arr, period){
        const res = [];
        const multiplier = 2 / (period + 1);
        let smaSum = 0;
        
        for(let i = 0; i < period; i++){
            smaSum += arr[i];
            res.push(null);
        }
        res[period - 1] = smaSum / period; // ç¬¬ä¸€å€‹ EMA å€¼ç­‰æ–¼ SMA
        let currentEMA = smaSum / period;
        
        for(let i = period; i < arr.length; i++){
            currentEMA = (arr[i] - currentEMA) * multiplier + currentEMA;
            res.push(currentEMA);
        }
        return res;
    }

    // æ¨™æº– WMA å‡½æ•¸ - è™•ç†æ•¸å€¼æ•¸çµ„
    function WMA(arr, period){
        const res = [];
        const denominator = (period * (period + 1)) / 2;
        for(let i = 0; i < arr.length; i++){
            if(i < period - 1){ res.push(null); continue; }
            let sum = 0;
            for(let j = 0; j < period; j++){
                sum += arr[i - period + 1 + j] * (j + 1);
            }
            res.push(sum / denominator);
        }
        return res;
    }

    function precomputeEMA(data, period) {
        let ema = [];
        const multiplier = 2 / (period + 1);
        let smaSum = 0;
        
        for (let i = 0; i < period; i++) {
            smaSum += data[i].close;
        }
        let currentEMA = smaSum / period;
        ema[period - 1] = currentEMA;
        
        for (let i = 0; i < period - 1; i++) {
            ema[i] = null;
        }
        
        for (let i = period; i < data.length; i++) {
            currentEMA = (data[i].close - currentEMA) * multiplier + currentEMA;
            ema[i] = currentEMA;
        }
        
        return ema;
    }

    function backtest(data, maS, maL, initialCash, startIdx, commission, recordTrades = false) {
        const COMMISSION = commission / 100;
        let cash = initialCash, shares = 0, distCap = 0, hasPos = false;
        let maxValue = initialCash, maxDD = 0, trades = [], allCrosses = [], tradeCount = 0;

        for (let i = startIdx; i < data.length; i++) {
            const price = data[i].close;
            const isLastDay = (i === data.length - 1);
            
            // äº¤å‰æª¢æ¸¬ï¼šæ¯”è¼ƒå‰ä¸€å¤©å’Œä»Šå¤©çš„ç›¸å°ä½ç½®ï¼ˆç¬¬ä¸€å¤©ç„¡æ³•æ¯”è¼ƒï¼Œå¾ç¬¬äºŒå¤©é–‹å§‹ï¼‰
            if (i > startIdx && maS[i] !== null && maL[i] !== null && maS[i-1] !== null && maL[i-1] !== null) {
                // é»ƒé‡‘äº¤å‰ï¼šå‰ä¸€å¤©çŸ­ç·šåœ¨ä¸‹ï¼Œä»Šå¤©çŸ­ç·šçœŸæ­£ç©¿éé•·ç·šï¼ˆä¸å«é‡ç–Šï¼‰
                if (maS[i-1] <= maL[i-1] && maS[i] > maL[i]) {
                    allCrosses.push({ date: data[i].date, type: 'gold', val: maS[i] });
                    if (!hasPos && !isLastDay) {
                        shares = Math.floor(cash / (price * (1 + COMMISSION)));
                        if (shares > 0) {
                            let cost = shares * price * (1 + COMMISSION);
                            distCap = cash; cash -= cost; hasPos = true;
                            tradeCount++;
                            if (recordTrades) trades.push({ date: data[i].date, action: 'è²·å…¥', price, shares });
                        }
                    }
                }
                // æ­»äº¡äº¤å‰ï¼šå‰ä¸€å¤©çŸ­ç·šåœ¨ä¸Šï¼Œä»Šå¤©çŸ­ç·šçœŸæ­£ç©¿éé•·ç·šï¼ˆä¸å«é‡ç–Šï¼‰
                else if (maS[i-1] >= maL[i-1] && maS[i] < maL[i]) {
                    allCrosses.push({ date: data[i].date, type: 'death', val: maS[i] });
                    if (hasPos) {
                        let sellVal = shares * price * (1 - COMMISSION);
                        let profit = (cash + sellVal) - distCap;
                        tradeCount++;
                        if (recordTrades) trades.push({ date: data[i].date, action: 'è³£å‡º', price, shares, profit: profit });
                        cash += sellVal; shares = 0; hasPos = false;
                    }
                }
            }
            
            if (hasPos && isLastDay) {
                let sellVal = shares * price * (1 - COMMISSION);
                tradeCount++;
                if (recordTrades) trades.push({ date: data[i].date, action: 'è³£å‡º(å¹³å€‰)', price, shares, profit: (cash + sellVal) - distCap });
                cash += sellVal; shares = 0; hasPos = false;
            }
            let currentVal = cash + (shares * price);
            maxValue = Math.max(maxValue, currentVal);
            maxDD = Math.max(maxDD, (maxValue - currentVal) / maxValue);
        }
        return { finalAsset: cash, maxDD: maxDD * 100, trades, allCrosses, tradeCount };
    }

    async function runOptimization() {
        const btn = document.getElementById('runBtn');
        g_initialCash = parseFloat(document.getElementById('initialCash').value);
        g_commission = parseFloat(document.getElementById('commission').value);
        const company = document.getElementById('companySelect').value;
        const sInt = dateToInt(document.getElementById('startDate').value);
        const eInt = dateToInt(document.getElementById('endDate').value);
        
        if (!window.csvRaw) return alert("è«‹å…ˆä¸Šå‚³ CSV");

        let data = window.csvRaw.map(r => ({ date: r[0], close: parseFloat(r[window.csvHeaders.indexOf(company)]) }))
                             .filter(d => !isNaN(d.close)).sort((a, b) => dateToInt(a.date) - dateToInt(b.date));
        // åŸå§‹ data ä¸­çš„ç´¢å¼•
        const startIdxFull = data.findIndex(d => dateToInt(d.date) >= sInt);
        const endIdx = data.findLastIndex(d => dateToInt(d.date) <= eInt);
        if (startIdxFull === -1 || endIdx === -1 || startIdxFull > endIdx) {
            alert('æ‰€é¸æ—¥æœŸç¯„åœæ²’æœ‰è³‡æ–™ï¼Œè«‹æª¢æŸ¥ CSV æˆ–æ—¥æœŸè¨­å®š');
            btn.disabled = false;
            document.getElementById('progWrapper').style.display = 'none';
            return;
        }
        // ç‚ºäº†è®“èµ·å§‹æ—¥æœŸç•¶å¤©å°±æœ‰ç§»å‹•å¹³å‡å€¼ï¼Œæˆ‘å€‘ä¿ç•™ startDate ä¹‹å‰æœ€å¤š MAX_PERIOD çš„æ­·å²è³‡æ–™ç”¨ä¾†è¨ˆç®— MA
        const sliceStartForCompute = Math.max(0, startIdxFull - MAX_PERIOD);
        g_backtestData = data.slice(sliceStartForCompute, endIdx + 1);
        // g_startIdx æŒ‡å‘ g_backtestData ä¸­å°æ‡‰ä½¿ç”¨è€…é¸å®šçš„ startDate çš„ç´¢å¼•
        g_startIdx = startIdxFull - sliceStartForCompute;

        btn.disabled = true; 
        document.getElementById('progWrapper').style.display = 'block';
        g_allMA = {};
        
        // Use numeric MA implementations on the closes array to avoid object-field mismatches
        const closesForMA = g_backtestData.map(d => (d.close !== undefined ? d.close : (d.Close !== undefined ? d.Close : NaN)));
        for (let p = 1; p <= MAX_PERIOD; p++){
            if (g_currentMode === 'SMA') g_allMA[p] = SMA(closesForMA, p);
            else if (g_currentMode === 'EMA') g_allMA[p] = EMA(closesForMA, p);
            else /* WMA */ g_allMA[p] = WMA(closesForMA, p);
        }

        // Debug: print WMA samples for quick verification
        if (g_currentMode === 'WMA'){
            console.log('=== WMA èª¿è©¦è³‡è¨Š ===');
            console.log('æ•¸æ“šé•·åº¦:', closesForMA.length);
            console.log('å‰10å€‹æ”¶ç›¤åƒ¹:', closesForMA.slice(0,10));
            console.log('g_startIdx (å›æ¸¬èµ·å§‹ç´¢å¼•):', g_startIdx);
            console.log('å›æ¸¬èµ·å§‹æ—¥æœŸ:', g_backtestData[g_startIdx]?.date);
            console.log('WMA5 å‰20å€‹å€¼:', g_allMA[5]?.slice(0,20));
            console.log('WMA20 å‰30å€‹å€¼:', g_allMA[20]?.slice(0,30));
            // è¼¸å‡ºå›æ¸¬æœŸé–“ç¬¬ä¸€å¤©çš„ WMA å€¼
            console.log('å›æ¸¬èµ·å§‹é» WMA5:', g_allMA[5]?.[g_startIdx]);
            console.log('å›æ¸¬èµ·å§‹é» WMA20:', g_allMA[20]?.[g_startIdx]);
        }

        let results = [];
        g_allResults = [];
        for (let s = 1; s <= MAX_PERIOD; s++) {
            if (s % 16 === 0) {
                document.getElementById('progFill').style.width = (s/MAX_PERIOD*100) + "%";
                await new Promise(r => setTimeout(r, 0));
            }
            for (let l = 1; l <= MAX_PERIOD; l++) {
                let res = backtest(g_backtestData, g_allMA[s], g_allMA[l], g_initialCash, g_startIdx, g_commission);
                let profit = res.finalAsset - g_initialCash;
                results.push({ s, l, ...res, profit });
                g_allResults.push({ s, l, finalAsset: res.finalAsset, profit });
            }
        }

        results.sort((a, b) => {
            // ç¬¬ä¸€å„ªå…ˆï¼šæœ€çµ‚è³‡ç”¢æœ€é«˜
            if (Math.abs(a.finalAsset - b.finalAsset) > 0.0000000001) return b.finalAsset - a.finalAsset;
            // ç¬¬äºŒå„ªå…ˆï¼š|çŸ­ç·š - é•·ç·š| çµ•å°å€¼æœ€å¤§
            let diffA = Math.abs(a.s - a.l), diffB = Math.abs(b.s - b.l);
            if (diffA !== diffB) return diffB - diffA;
            // ç¬¬ä¸‰å„ªå…ˆï¼šçŸ­ç·šé€±æœŸæœ€å°
            return a.s - b.s;
        });

        g_rankedResults = results; // ä¿å­˜æ‰€æœ‰æ’åºç»“æœç”¨äºå¿«é€ŸæŸ¥è¯¢
        updateRankTable(results.slice(0, 65536)); 
        showSpecificResult(results[0].s, results[0].l, 1, null, g_commission);
        render2DChart();
        render3DChart();
        document.getElementById('chartGrid').style.display = 'grid';
        document.getElementById('querySection').classList.remove('hidden'); // æ˜¾ç¤ºå¿«é€ŸæŸ¥è¯¢åŒºåŸŸ
        btn.disabled = false; 
        document.getElementById('progWrapper').style.display = 'none';
    }

    function updateRankTable(top) {
        document.querySelector("#topTable tbody").innerHTML = top.map((r, i) => 
            `<tr onclick="showSpecificResult(${r.s}, ${r.l}, ${i+1}, this)">
                <td>${i+1}</td><td>${r.s}/${r.l}</td><td>${r.tradeCount}</td><td>$${formatCurrency(r.finalAsset)}</td>
            </tr>`).join('');
    }

    function showSpecificResult(s, l, rank, element = null, commission = g_commission) {
        if (element) {
            document.querySelectorAll('#topTable tbody tr').forEach(tr => tr.classList.remove('selected'));
            element.classList.add('selected');
        }

        const sVal = s, lVal = l;
        const data = g_backtestData;
        const mS = g_allMA[sVal], mL = g_allMA[lVal];
        let result = backtest(data, mS, mL, g_initialCash, g_startIdx, commission, true);
        const trades = result.trades, allCrosses = result.allCrosses;

        // ç‚ºäº†è®“åœ–è¡¨åªé¡¯ç¤ºä½¿ç”¨è€…æŒ‡å®šçš„èµ·å§‹æ—¥ä¹‹å¾Œçš„è³‡æ–™ï¼Œå»ºç«‹ displayData
        const displayData = data.slice(g_startIdx);
        const displayMS = mS ? mS.slice(g_startIdx) : [];
        const displayML = mL ? mL.slice(g_startIdx) : [];

        document.getElementById('bestResult').innerHTML = `
            <h3>æ’å #${rank} - æœ€å„ªåƒæ•¸: <span style="color: #e74c3c;">${sVal}/${lVal}</span></h3>
            <p>æœ€çµ‚è³‡ç”¢: <strong style="color: #27ae60;">$${formatCurrency(result.finalAsset)}</strong></p>
            <p>ç²åˆ©: <span style="color: #3498db;">$${formatCurrency(result.finalAsset - g_initialCash)}</span></p>
            <p>æ”¶ç›Šç‡: <span>${((result.finalAsset / g_initialCash - 1) * 100).toFixed(10)}%</span></p>
            <p>æœ€å¤§å›æ’¤: <span>${result.maxDD.toFixed(10)}%</span></p>
            <p>äº¤æ˜“ç­†æ•¸: <strong>${trades.length}</strong></p>
        `;

        document.querySelector("#tradeTable tbody").innerHTML = trades.map((t, i) => 
            `<tr>
                <td>${t.date}</td>
                <td class="${t.action.includes('è²·') ? 'buy-text' : 'sell-text'}">${t.action}</td>
                <td>$${t.price.toFixed(10)}</td>
                <td>${t.shares}</td>
                <td class="${t.profit > 0 ? 'buy-text' : t.profit === 0 ? '' : 'sell-text'}">${t.profit ? `$${formatCurrency(t.profit)}` : '-'}</td>
            </tr>`).join('');

        if (chartInstance) chartInstance.destroy();
        const ctx = document.getElementById("mainChart").getContext("2d");
        const modeLabel = g_currentMode;
        chartInstance = new Chart(ctx, {
            type: "line",
            data: {
                labels: displayData.map(d => d.date),
                datasets: [
                    { label: 'å¯¦éš›è²·å…¥', data: displayData.map(d => trades.find(t => t.date === d.date && t.action === 'è²·å…¥') ? d.close : null), borderColor: '#27ae60', backgroundColor: '#27ae60', pointStyle: 'rectRot', pointRadius: 10, showLine: false, z: 10 },
                    { label: 'å¯¦éš›è³£å‡º/å¹³å€‰', data: displayData.map(d => trades.find(t => t.date === d.date && (t.action === 'è³£å‡º' || t.action === 'è³£å‡º(å¹³å€‰)')) ? d.close : null), borderColor: '#e74c3c', backgroundColor: '#e74c3c', pointStyle: 'rectRot', pointRadius: 10, showLine: false, z: 10 },
                    { label: 'é»ƒé‡‘äº¤å‰', data: displayData.map(d => {
                        const cross = allCrosses.find(c => c.date === d.date && c.type === 'gold');
                        return cross ? cross.val : null;
                    }), borderColor: '#f1c40f', pointStyle: 'circle', pointRadius: 5, showLine: false, z: 5 },
                    { label: 'æ­»äº¡äº¤å‰', data: displayData.map(d => {
                        const cross = allCrosses.find(c => c.date === d.date && c.type === 'death');
                        return cross ? cross.val : null;
                    }), borderColor: '#95a5a6', pointStyle: 'circle', pointRadius: 5, showLine: false, z: 5 },
                    { label: 'æ”¶ç›¤åƒ¹', data: displayData.map(d => d.close), borderColor: '#ddd', borderWidth: 1, pointRadius: 0, z: 1 },
                    { label: `${modeLabel} ${sVal}`, data: displayMS, borderColor: '#e74c3c', borderWidth: 2, pointRadius: 0, z: 2 },
                    { label: `${modeLabel} ${lVal}`, data: displayML, borderColor: '#3498db', borderWidth: 2, pointRadius: 0, z: 2 }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { usePointStyle: true } }
                }
            }
        });
    }

    // æ–°å¢ï¼š2D ç†±åŠ›åœ–
    function render2DChart() {
        const container = document.getElementById('scatter2dChart');
        
        const maxPeriod = Math.max(...g_allResults.map(r => Math.max(r.s, r.l)));
        const heatmapData = Array(maxPeriod).fill(0).map(() => Array(maxPeriod).fill(null));
        
        for (let r of g_allResults) {
            if (r.s <= maxPeriod && r.l <= maxPeriod) {
                heatmapData[r.l - 1][r.s - 1] = r.profit;
            }
        }

        const trace = {
            z: heatmapData,
            x: Array.from({length: maxPeriod}, (_, i) => i + 1),
            y: Array.from({length: maxPeriod}, (_, i) => i + 1),
            type: 'heatmap',
            colorscale: [
                [0, '#0000ff'],
                [0.167, '#0080ff'],
                [0.333, '#00ffff'],
                [0.5, '#00ff00'],
                [0.667, '#ffff00'],
                [0.833, '#ff8000'],
                [1, '#ff0000']
            ],
            hovertemplate: 'çŸ­æœŸ: %{x}<br>é•·æœŸ: %{y}<br>ç²åˆ©: $%{z:,.0f}<extra></extra>',
            showscale: true
        };

        const layout = {
            title: 'åƒæ•¸çµ„åˆç²åˆ©ç†±åŠ›åœ–',
            xaxis: { title: 'çŸ­æœŸå‡ç·šé€±æœŸ', showgrid: false },
            yaxis: { title: 'é•·æœŸå‡ç·šé€±æœŸ', showgrid: false },
            margin: { l: 80, r: 80, t: 60, b: 80 },
            font: { family: 'Segoe UI', size: 12 },
            hovermode: 'closest'
        };

        Plotly.newPlot(container, [trace], layout, { responsive: true, displayModeBar: true });
    }

    // æ–°å¢ï¼š3D è¡¨é¢åœ–
    function render3DChart() {
        const container = document.getElementById('canvas3d');
        
        const maxPeriod = Math.max(...g_allResults.map(r => Math.max(r.s, r.l)));
        const surfaceData = Array(maxPeriod).fill(0).map(() => Array(maxPeriod).fill(null));
        
        for (let r of g_allResults) {
            if (r.s <= maxPeriod && r.l <= maxPeriod) {
                surfaceData[r.l - 1][r.s - 1] = r.profit;
            }
        }

        const trace = {
            z: surfaceData,
            x: Array.from({length: maxPeriod}, (_, i) => i + 1),
            y: Array.from({length: maxPeriod}, (_, i) => i + 1),
            type: 'surface',
            colorscale: [
                [0, '#0000ff'],
                [0.167, '#0080ff'],
                [0.333, '#00ffff'],
                [0.5, '#00ff00'],
                [0.667, '#ffff00'],
                [0.833, '#ff8000'],
                [1, '#ff0000']
            ],
            hovertemplate: 'çŸ­æœŸ: %{x}<br>é•·æœŸ: %{y}<br>ç²åˆ©: $%{z:,.0f}<extra></extra>',
            showscale: true,
            opacity: 0.9
        };

        const layout = {
            title: '3D åƒæ•¸å„ªåŒ–ç©ºé–“',
            scene: {
                xaxis: { title: 'çŸ­æœŸé€±æœŸ' },
                yaxis: { title: 'é•·æœŸé€±æœŸ' },
                zaxis: { title: 'ç²åˆ© ($)' },
                aspectmode: 'auto',
                camera: {
                    eye: { x: 1.8, y: 1.8, z: 1.4 }
                }
            },
            margin: { l: 0, r: 0, t: 60, b: 0 },
            font: { family: 'Segoe UI', size: 12 },
            hovermode: 'closest'
        };

        Plotly.newPlot(container, [trace], layout, { responsive: true, displayModeBar: true });
    }

    // æ–°å¢ï¼šå¿«é€ŸæŸ¥è©¢åŠŸèƒ½
    function quickQuery() {
        const input = document.getElementById('queryInput').value.trim();
        const resultDiv = document.getElementById('queryResult');
        
        if (!input) {
            resultDiv.innerHTML = '<span style="color: #e74c3c;">è«‹è¼¸å…¥çµ„åˆ (ä¾‹: 5/20)</span>';
            return;
        }

        const parts = input.split('/');
        if (parts.length !== 2) {
            resultDiv.innerHTML = '<span style="color: #e74c3c;">æ ¼å¼éŒ¯èª¤ï¼è«‹è¼¸å…¥ çŸ­æœŸ/é•·æœŸ (ä¾‹: 5/20)</span>';
            return;
        }

        const s = parseInt(parts[0].trim());
        const l = parseInt(parts[1].trim());

        if (isNaN(s) || isNaN(l) || s <= 0 || l <= 0) {
            resultDiv.innerHTML = '<span style="color: #e74c3c;">ç„¡æ•ˆæ•¸å€¼ï¼</span>';
            return;
        }

        // æŸ¥æ‰¾åŒ¹é…çš„çµæœ
        const found = g_rankedResults.find(r => r.s === s && r.l === l);
        
        if (!found) {
            resultDiv.innerHTML = `<span style="color: #e74c3c;">æ‰¾ä¸åˆ°çµ„åˆ ${s}/${l}</span>`;
            return;
        }

        // æ‰¾å‡ºæ’å
        const rank = g_rankedResults.indexOf(found) + 1;
        
        // é¡¯ç¤ºçµæœä¸¦å±•ç¤ºè©²çµ„åˆçš„è©³ç´°ä¿¡æ¯
        resultDiv.innerHTML = `
            <span style="color: #27ae60;">âœ“ æ’åç¬¬ <strong>${rank}</strong> å | 
            æœ€çµ‚è³‡ç”¢: <strong>$${formatCurrency(found.finalAsset)}</strong> | 
            ç²åˆ©: <strong style="color: #3498db;">$${formatCurrency(found.profit)}</strong></span>
        `;
        
        // è‡ªå‹•é¡¯ç¤ºè©²çµ„åˆçš„è©³ç´°äº¤æ˜“ä¿¡æ¯
        const trElement = document.querySelector(`#topTable tbody tr:nth-child(${Math.min(rank, 20)})`);
        showSpecificResult(s, l, rank, trElement, g_commission);
        
        // å¦‚æœæ’ååœ¨å‰20åä¹‹å¤–ï¼Œæ»¾å‹•é é¢
        if (rank > 20) {
            document.getElementById('bestResult').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // æŒ‰ Enter éµå¿«é€ŸæŸ¥è©¢
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') quickQuery();
        });
    });
    
    // æŸ¥è©¢æ¨¡å¼åˆ‡æ›
    function switchQueryMode(mode) {
        if (mode === 'single') {
            document.getElementById('singleQueryMode').style.display = 'block';
            document.getElementById('batchQueryMode').style.display = 'none';
            document.querySelectorAll('.query-mode-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        } else {
            document.getElementById('singleQueryMode').style.display = 'none';
            document.getElementById('batchQueryMode').style.display = 'block';
            document.querySelectorAll('.query-mode-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
    }
    
    // æ‰¹é‡æŸ¥è©¢åŠŸèƒ½
    function batchQuery() {
        const input = document.getElementById('batchQueryInput').value.trim();
        const resultDiv = document.getElementById('batchQueryResult');
        
        if (!input) {
            resultDiv.innerHTML = '<div class="batch-result-item batch-error">âŒ è«‹è¼¸å…¥çµ„åˆ</div>';
            return;
        }
        
        const lines = input.split('\n').map(line => line.trim()).filter(line => line);
        let results = [];
        
        for (let line of lines) {
            const parts = line.split('/');
            if (parts.length !== 2) {
                results.push(`<div class="batch-result-item batch-error">âŒ ${line} - æ ¼å¼éŒ¯èª¤</div>`);
                continue;
            }
            
            const s = parseInt(parts[0].trim());
            const l = parseInt(parts[1].trim());
            
            if (isNaN(s) || isNaN(l) || s <= 0 || l <= 0) {
                results.push(`<div class="batch-result-item batch-error">âŒ ${line} - ç„¡æ•ˆæ•¸å€¼</div>`);
                continue;
            }
            
            const found = g_rankedResults.find(r => r.s === s && r.l === l);
            
            if (!found) {
                results.push(`<div class="batch-result-item batch-error">âŒ ${line} - æ‰¾ä¸åˆ°çµ„åˆ</div>`);
                continue;
            }
            
            const rank = g_rankedResults.indexOf(found) + 1;
            const returnRate = ((found.finalAsset / g_initialCash - 1) * 100).toFixed(2);
            results.push(`<div class="batch-result-item batch-success">âœ“ ${s}/${l} - æ’å #${rank} | $${formatCurrency(found.finalAsset)}</div>`);
        }
        
        resultDiv.innerHTML = results.join('');
    }
</script>

</body>
</html>

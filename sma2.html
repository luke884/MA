<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å‡ç·šå›æ¸¬ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 2px solid #ddd; }
        
        .mode-selector { display: flex; gap: 10px; margin-bottom: 25px; }
        .mode-btn { padding: 12px 24px; background: #e0e0e0; border: 2px solid #999; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        .mode-btn:hover { background: #d0d0d0; }
        .mode-btn.active { background: var(--accent); color: white; border-color: #2980b9; }
        
        h1 { color: var(--primary); border-bottom: 3px solid #333; padding-bottom: 10px; }
        .input-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        input, select { padding: 10px; border: 2px solid #bbb; border-radius: 6px; }
        button { grid-column: span 2; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #2980b9; }
        
        .progress-wrapper { display: none; margin: 20px 0; }
        .progress-bar { height: 12px; background: #eee; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.1s; }
        
        .results-grid { display: grid; grid-template-columns: 400px 1fr; gap: 20px; margin-top: 30px; }
        .side-panel { display: flex; flex-direction: column; gap: 20px; }
        .stats-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 5px solid var(--accent); }
        
        .rank-table-wrapper { max-height: 550px; overflow-y: auto; border: 2px solid #999; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
        th, td { border: 2px solid #ccc; padding: 10px; text-align: center; }
        th { background: #f8f9fa; position: sticky; top: 0; z-index: 1; }

        #topTable tbody tr { cursor: pointer; transition: 0.2s; }
        #topTable tbody tr:hover { background: #e3f2fd; }
        #topTable tbody tr.selected { background: #bbdefb; font-weight: bold; }

        .trade-table-wrapper { max-height: 400px; overflow-y: auto; border: 2px solid #999; margin-top: 10px; }
        .buy-text { color: var(--success); font-weight: bold; }
        .sell-text { color: var(--danger); font-weight: bold; }
        .final-text { color: #e74c3c; font-weight: bold; font-style: italic; }
        
        #chartContainer { width: 100%; height: 450px; margin-top: 10px; }
        
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; max-width: 100%; }
        .chart-card { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 2px solid #ddd; overflow: hidden; }
        .chart-title { font-size: 16px; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        #scatter2dChart, #canvas3d { width: 100%; height: 500px; display: block; }
        
        .yearly-results { margin-top: 30px; display: none; }
        .yearly-results.show { display: block; }
        .yearly-header { color: var(--success); font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 3px solid var(--success); padding-bottom: 10px; }
        .yearly-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .yearly-card { background: #f0f8f0; padding: 15px; border-radius: 8px; border-left: 5px solid var(--success); }
        .yearly-card h4 { margin: 0 0 10px 0; color: var(--primary); }
        .yearly-card p { margin: 5px 0; font-size: 13px; }
        .intersection-table-wrapper { max-height: 600px; overflow-y: auto; border: 2px solid var(--success); border-radius: 6px; background: white; }
        
        .stability-section { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--success); display: none; }
        .stability-section.show { display: block; }
        .stability-title { color: var(--success); font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .stability-title::before { content: ''; display: inline-block; width: 6px; height: 20px; background: var(--success); border-radius: 3px; }
        #stabilityHeatmap { width: 100%; height: auto; min-height: 600px; }
        .stable-params-info { background: white; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .stable-params-info h4 { margin-top: 0; color: var(--primary); font-size: 16px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        
    </style>
</head>
<body>

<div class="container">
    <div class="mode-selector">
        <button class="mode-btn active" onclick="switchMode('SMA')">SMA ç°¡å–®å‡ç·š</button>
        <button class="mode-btn" onclick="switchMode('WMA')">WMA åŠ æ¬Šå‡ç·š</button>
        <button class="mode-btn" onclick="switchMode('EMA')">EMA æŒ‡æ•¸å‡ç·š</button>
    </div>
    
    <h1 id="pageTitle">SMA å‡ç·šå›æ¸¬ç³»çµ±</h1>

    <div class="input-section">
        <div class="input-group"><label>åˆå§‹è³‡é‡‘</label><input id="initialCash" type="number" value="10000"></div>
        <div class="input-group"><label>é¸æ“‡å…¬å¸</label><select id="companySelect"><option>è«‹å…ˆä¸Šå‚³ CSV</option></select></div>
        <div class="input-group"><label>èµ·å§‹æ—¥æœŸ</label><input id="startDate" type="date" value="2024-01-01"></div>
        <div class="input-group"><label>çµæŸæ—¥æœŸ</label><input id="endDate" type="date" value="2024-12-31"></div>
        <div class="input-group"><label>æ‰‹çºŒè²» (%)</label><input id="commission" type="number" value="0.08" step="0.01"></div>
        <div class="input-group"><label>åˆ†æèµ·å§‹å¹´</label><select id="yearStart"><option value="">è«‹å…ˆä¸Šå‚³ CSV</option></select></div>
        <div class="input-group"><label>åˆ†æçµæŸå¹´</label><select id="yearEnd"><option value="">è«‹å…ˆä¸Šå‚³ CSV</option></select></div>
        <div class="input-group" style="grid-column: span 2;"><label>ä¸Šå‚³ CSV æª”æ¡ˆ</label><input id="csvFile" type="file" accept=".csv"></div>
        <button id="runBtn" onclick="runOptimization()">é–‹å§‹å…¨åƒæ•¸æœ€ä½³åŒ–</button>
        <button id="yearlyBtn" onclick="runYearlyIntersection()" style="background: var(--success);">åƒæ•¸ç©©å®šæ€§åˆ†æ</button>
    </div>

    <div class="progress-wrapper" id="progWrapper">
        <label id="progLabel">è¨ˆç®—é€²åº¦...</label>
        <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>
    </div>

    <div class="results-grid">
        <div class="side-panel">
            <div id="bestResult" class="stats-card">å°šæœªåŸ·è¡Œ</div>
            <h3>ğŸ† æ’è¡Œæ¦œ (Top 20)</h3>
            <div class="rank-table-wrapper">
                <table id="topTable">
                    <thead><tr><th>æ’å</th><th>çŸ­/é•·</th><th>äº¤æ˜“ç­†æ•¸</th><th>æœ€çµ‚è³‡ç”¢</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div>
            <div id="chartContainer"><canvas id="mainChart"></canvas></div>
            <h3 id="tableTitle">ğŸ“‘ äº¤æ˜“æ˜ç´°</h3>
            <div class="trade-table-wrapper">
                <table id="tradeTable">
                    <thead><tr><th>æ—¥æœŸ</th><th>å‹•ä½œ</th><th>åƒ¹æ ¼</th><th>è‚¡æ•¸</th><th>ç²åˆ©</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="chart-grid" id="chartGrid" style="display: none;">
        <div class="chart-card">
            <div class="chart-title">ğŸ“Š 2D ç†±åŠ›åœ– - åƒæ•¸èˆ‡ç²åˆ©</div>
            <div id="scatter2dChart"></div>
        </div>
        <div class="chart-card">
            <div class="chart-title">ğŸ® 3D è¡¨é¢åœ– - åƒæ•¸å„ªåŒ–ç©ºé–“</div>
            <div id="canvas3d"></div>
        </div>
    </div>

    <div class="yearly-results" id="yearlyResults">
        <div class="yearly-header">ğŸ“… æŒ‰å¹´ä»½åˆ†æçµæœ</div>
        <div class="yearly-grid" id="yearlyGrid"></div>
        <h3 style="color: var(--success); margin-top: 20px;">âœ¨ æ¯å¹´éƒ½æ²’è™§éŒ¢çš„åƒæ•¸çµ„åˆ</h3>
        <div class="intersection-table-wrapper">
            <table id="intersectionTable">
                <thead><tr><th>æ’å</th><th>çŸ­/é•·</th><th>å¹³å‡ç²åˆ©</th><th>ç²åˆ©å¹´æ•¸</th><th>è©³æƒ…</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="stability-section" id="stabilitySection">
        <div class="stability-title">ğŸ”¥ åƒæ•¸ç©©å®šæ€§ç†±åŠ›åœ– - å¹´ä»½ç¶­åº¦</div>
        <p style="color: #666; margin-bottom: 15px;">é¡è‰²è¶Šç´…è¡¨ç¤ºè©²åƒæ•¸åœ¨è©²å¹´ç²åˆ©è¶Šé«˜ï¼Œåªé¡¯ç¤ºæ‰€æœ‰å¹´ä»½éƒ½æ²’è™§éŒ¢çš„åƒæ•¸çµ„åˆ</p>
        <div id="stabilityHeatmap"></div>
        <div class="stable-params-info">
            <h4>âœ¨ è·¨å¹´ä»½æœ€ç©©å®šåƒæ•¸ TOP 10</h4>
            <p style="font-size: 12px; color: #999; margin-bottom: 10px;">é»æ“Šä»»ä½•åƒæ•¸å¯æŸ¥çœ‹è©³ç´°å›æ¸¬çµæœ</p>
            <div id="stableParamsList"></div>
        </div>
    </div>
</div>

<script>
    let g_backtestData = [], g_allMA = {}, g_startIdx = 0, g_initialCash = 0, g_commission = 0, chartInstance = null;
    let g_currentMode = 'SMA';
    let g_allResults = [];
    const MAX_PERIOD = 256;

    function switchMode(mode) {
        g_currentMode = mode;
        const title = mode === 'SMA' ? 'SMA å‡ç·šå›æ¸¬ç³»çµ±' : (mode === 'WMA' ? 'WMA å‡ç·šå›æ¸¬ç³»çµ±' : 'EMA å‡ç·šå›æ¸¬ç³»çµ±');
        document.getElementById('pageTitle').innerText = title;
        
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.getElementById('bestResult').innerHTML = 'å°šæœªåŸ·è¡Œ';
        document.querySelector("#topTable tbody").innerHTML = '';
        document.querySelector("#tradeTable tbody").innerHTML = '';
        if (chartInstance) chartInstance.destroy();
        document.getElementById('chartGrid').style.display = 'none';
        g_allMA = {};
    }

    function formatCurrency(num) {
        return num.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function dateToInt(dStr) {
        if (!dStr) return 0;
        const parts = dStr.includes('-') ? dStr.split('-') : dStr.split('/');
        if (parts.length !== 3) return 0;
        const [y, m, d] = dStr.includes('-') ? parts : [parts[2], parts[0], parts[1]];
        return parseInt(y + m.padStart(2, '0') + d.padStart(2, '0'));
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const lines = event.target.result.trim().split("\n");
            window.csvHeaders = lines[0].split(",").map(h => h.trim());
            window.csvRaw = lines.slice(1).map(line => line.split(","));
            document.getElementById("companySelect").innerHTML = window.csvHeaders.slice(1).map(h => `<option value="${h}">${h}</option>`).join('');
            
            // è‡ªå‹•å¡«å……å¹´ä»½é¸æ“‡å™¨
            const years = new Set();
            window.csvRaw.forEach(r => {
                const dateStr = r[0];
                const year = dateStr.includes('-') ? dateStr.split('-')[0] : dateStr.split('/')[2];
                if (year && year.length === 4) years.add(year);
            });
            const sortedYears = [...years].sort();
            document.getElementById('yearStart').innerHTML = sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');
            document.getElementById('yearEnd').innerHTML = sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');
            // é è¨­é¸æ“‡æœ€å¾Œä¸€å¹´ä½œç‚ºçµæŸå¹´
            if (sortedYears.length > 0) {
                document.getElementById('yearEnd').value = sortedYears[sortedYears.length - 1];
                // é è¨­é¸æ“‡10å¹´å‰æˆ–æœ€æ—©å¹´ä»½ä½œç‚ºèµ·å§‹å¹´
                const startIdx = Math.max(0, sortedYears.length - 10);
                document.getElementById('yearStart').value = sortedYears[startIdx];
            }
        };
        reader.readAsText(e.target.files[0]);
    });

    function precomputeSMA(data, period) {
        let sma = [], sum = 0;
        for (let i = 0; i < data.length; i++) {
            sum += data[i].close;
            if (i >= period) sum -= data[i - period].close;
            sma.push(i >= period - 1 ? sum / period : null);
        }
        return sma;
    }

    function precomputeWMA(data, period) {
        let wma = [];
        for (let i = 0; i < data.length; i++) {
            if (i < period - 1) {
                wma.push(null);
            } else {
                let sum = 0, weightSum = 0;
                for (let j = 0; j < period; j++) {
                    let weight = j + 1;  // æ¬Šé‡: 1, 2, 3, ..., period
                    sum += data[i - period + j].close * weight;  // æ­£ç¢ºç´¢å¼•
                    weightSum += weight;
                }
                wma.push(sum / weightSum);
            }
        }
        return wma;
    }

    function precomputeEMA(data, period) {
        let ema = [];
        const multiplier = 2 / (period + 1);
        let smaSum = 0;
        
        for (let i = 0; i < period; i++) {
            smaSum += data[i].close;
        }
        let currentEMA = smaSum / period;
        ema[period - 1] = currentEMA;
        
        for (let i = 0; i < period - 1; i++) {
            ema[i] = null;
        }
        
        for (let i = period; i < data.length; i++) {
            currentEMA = (data[i].close - currentEMA) * multiplier + currentEMA;
            ema[i] = currentEMA;
        }
        
        return ema;
    }

    function backtest(data, maS, maL, initialCash, startIdx, commission, recordTrades = false) {
        const COMMISSION = commission / 100;
        let cash = initialCash, shares = 0, distCap = 0, hasPos = false;
        let maxValue = initialCash, maxDD = 0, trades = [], allCrosses = [], tradeCount = 0;

        for (let i = startIdx; i < data.length; i++) {
            const price = data[i].close;
            const isLastDay = (i === data.length - 1);
            
            if (i > 0 && maS[i-1] !== null && maL[i-1] !== null) {
                if (maS[i-1] < maL[i-1] && maS[i] >= maL[i]) {
                    allCrosses.push({ date: data[i].date, type: 'gold', val: maS[i] });
                    if (!hasPos && !isLastDay) {
                        shares = Math.floor(cash / (price * (1 + COMMISSION)));
                        if (shares > 0) {
                            let cost = shares * price * (1 + COMMISSION);
                            distCap = cash; cash -= cost; hasPos = true;
                            tradeCount++;
                            if (recordTrades) trades.push({ date: data[i].date, action: 'è²·å…¥', price, shares });
                        }
                    }
                } 
                else if (maS[i-1] > maL[i-1] && maS[i] <= maL[i]) {
                    allCrosses.push({ date: data[i].date, type: 'death', val: maS[i] });
                    if (hasPos) {
                        let sellVal = shares * price * (1 - COMMISSION);
                        let profit = (cash + sellVal) - distCap;
                        tradeCount++;
                        if (recordTrades) trades.push({ date: data[i].date, action: 'è³£å‡º', price, shares, profit: profit });
                        cash += sellVal; shares = 0; hasPos = false;
                    }
                }
            }
            
            if (hasPos && isLastDay) {
                let sellVal = shares * price * (1 - COMMISSION);
                tradeCount++;
                if (recordTrades) trades.push({ date: data[i].date, action: 'è³£å‡º(å¹³å€‰)', price, shares, profit: (cash + sellVal) - distCap });
                cash += sellVal; shares = 0; hasPos = false;
            }
            let currentVal = cash + (shares * price);
            maxValue = Math.max(maxValue, currentVal);
            maxDD = Math.max(maxDD, (maxValue - currentVal) / maxValue);
        }
        return { finalAsset: cash, maxDD: maxDD * 100, trades, allCrosses, tradeCount };
    }

    // å¹´ä»½å›æ¸¬ï¼šä½¿ç”¨å®Œæ•´æ•¸æ“šçš„MAï¼Œä½†åªåœ¨æŒ‡å®šå¹´ä»½ç¯„åœå…§é€²è¡Œäº¤æ˜“
    function backtestYearly(data, maS, maL, initialCash, yearStartIdx, yearEndIdx, commission) {
        const COMMISSION = commission / 100;
        let cash = initialCash, shares = 0, distCap = 0, hasPos = false;
        let maxValue = initialCash, maxDD = 0, tradeCount = 0;

        for (let i = yearStartIdx; i <= yearEndIdx; i++) {
            const price = data[i].close;
            const isLastDay = (i === yearEndIdx);
            
            if (i > 0 && maS[i-1] !== null && maL[i-1] !== null && maS[i] !== null && maL[i] !== null) {
                // é»ƒé‡‘äº¤å‰ï¼šè²·å…¥
                if (maS[i-1] < maL[i-1] && maS[i] >= maL[i]) {
                    if (!hasPos && !isLastDay) {
                        shares = Math.floor(cash / (price * (1 + COMMISSION)));
                        if (shares > 0) {
                            let cost = shares * price * (1 + COMMISSION);
                            distCap = cash; cash -= cost; hasPos = true;
                            tradeCount++;
                        }
                    }
                } 
                // æ­»äº¡äº¤å‰ï¼šè³£å‡º
                else if (maS[i-1] > maL[i-1] && maS[i] <= maL[i]) {
                    if (hasPos) {
                        let sellVal = shares * price * (1 - COMMISSION);
                        tradeCount++;
                        cash += sellVal; shares = 0; hasPos = false;
                    }
                }
            }
            
            // å¹´æœ«å¹³å€‰
            if (hasPos && isLastDay) {
                let sellVal = shares * price * (1 - COMMISSION);
                tradeCount++;
                cash += sellVal; shares = 0; hasPos = false;
            }
            
            let currentVal = cash + (shares * price);
            maxValue = Math.max(maxValue, currentVal);
            maxDD = Math.max(maxDD, (maxValue - currentVal) / maxValue);
        }
        return { finalAsset: cash, maxDD: maxDD * 100, tradeCount };
    }

    async function runOptimization() {
        const btn = document.getElementById('runBtn');
        g_initialCash = parseFloat(document.getElementById('initialCash').value);
        g_commission = parseFloat(document.getElementById('commission').value);
        const company = document.getElementById('companySelect').value;
        const sInt = dateToInt(document.getElementById('startDate').value);
        const eInt = dateToInt(document.getElementById('endDate').value);
        
        if (!window.csvRaw) return alert("è«‹å…ˆä¸Šå‚³ CSV");

        let data = window.csvRaw.map(r => ({ date: r[0], close: parseFloat(r[window.csvHeaders.indexOf(company)]) }))
                             .filter(d => !isNaN(d.close)).sort((a, b) => dateToInt(a.date) - dateToInt(b.date));
        const startIdxFull = data.findIndex(d => dateToInt(d.date) >= sInt);
        const endIdx = data.findLastIndex(d => dateToInt(d.date) <= eInt);
        if (startIdxFull === -1 || endIdx === -1 || startIdxFull > endIdx) {
            alert('æ‰€é¸æ—¥æœŸç¯„åœæ²’æœ‰è³‡æ–™ï¼Œè«‹æª¢æŸ¥ CSV æˆ–æ—¥æœŸè¨­å®š');
            btn.disabled = false;
            document.getElementById('progWrapper').style.display = 'none';
            return;
        }
        const sliceStartForCompute = Math.max(0, startIdxFull - MAX_PERIOD);
        g_backtestData = data.slice(sliceStartForCompute, endIdx + 1);
        g_startIdx = startIdxFull - sliceStartForCompute;

        btn.disabled = true; 
        document.getElementById('progWrapper').style.display = 'block';
        g_allMA = {};
        
        const computeFunc = g_currentMode === 'SMA' ? precomputeSMA : (g_currentMode === 'WMA' ? precomputeWMA : precomputeEMA);
        for (let p = 1; p <= MAX_PERIOD; p++) g_allMA[p] = computeFunc(g_backtestData, p);

        let results = [];
        g_allResults = [];
        for (let s = 1; s <= MAX_PERIOD; s++) {
            if (s % 16 === 0) {
                document.getElementById('progFill').style.width = (s/MAX_PERIOD*100) + "%";
                await new Promise(r => setTimeout(r, 0));
            }
            for (let l = 1; l <= MAX_PERIOD; l++) {
                let res = backtest(g_backtestData, g_allMA[s], g_allMA[l], g_initialCash, g_startIdx, g_commission);
                let profit = res.finalAsset - g_initialCash;
                results.push({ s, l, ...res, profit });
                g_allResults.push({ s, l, finalAsset: res.finalAsset, profit });
            }
        }

        results.sort((a, b) => {
            if (Math.abs(a.finalAsset - b.finalAsset) > 0.01) return b.finalAsset - a.finalAsset;
            let diffA = Math.abs(a.s - a.l), diffB = Math.abs(b.s - b.l);
            if (diffA !== diffB) return diffB - diffA; 
            if (a.s !== b.s) return a.s - b.s;
            return a.l - b.l;
        });

        updateRankTable(results.slice(0, 20)); 
        showSpecificResult(results[0].s, results[0].l, 1, null, g_commission);
        render2DChart();
        render3DChart();
        document.getElementById('chartGrid').style.display = 'grid';
        btn.disabled = false; 
        document.getElementById('progWrapper').style.display = 'none';
    }

    function updateRankTable(top) {
        document.querySelector("#topTable tbody").innerHTML = top.map((r, i) => 
            `<tr onclick="showSpecificResult(${r.s}, ${r.l}, ${i+1}, this)">
                <td>${i+1}</td><td>${r.s}/${r.l}</td><td>${r.tradeCount}</td><td>$${formatCurrency(r.finalAsset)}</td>
            </tr>`).join('');
    }

    function showSpecificResult(s, l, rank, element = null, commission = g_commission) {
        if (element) {
            document.querySelectorAll('#topTable tbody tr').forEach(tr => tr.classList.remove('selected'));
            element.classList.add('selected');
        }

        const sVal = s, lVal = l;
        const data = g_backtestData;
        const mS = g_allMA[sVal], mL = g_allMA[lVal];
        let result = backtest(data, mS, mL, g_initialCash, g_startIdx, commission, true);
        const trades = result.trades, allCrosses = result.allCrosses;

        const displayData = data.slice(g_startIdx);
        const displayMS = mS ? mS.slice(g_startIdx) : [];
        const displayML = mL ? mL.slice(g_startIdx) : [];

        document.getElementById('bestResult').innerHTML = `
            <h3>æ’å #${rank} - æœ€å„ªåƒæ•¸: <span style="color: #e74c3c;">${sVal}/${lVal}</span></h3>
            <p>æœ€çµ‚è³‡ç”¢: <strong style="color: #27ae60;">$${formatCurrency(result.finalAsset)}</strong></p>
            <p>ç²åˆ©: <span style="color: #3498db;">$${formatCurrency(result.finalAsset - g_initialCash)}</span></p>
            <p>æ”¶ç›Šç‡: <span>${((result.finalAsset / g_initialCash - 1) * 100).toFixed(2)}%</span></p>
            <p>æœ€å¤§å›æ’¤: <span>${result.maxDD.toFixed(2)}%</span></p>
            <p>äº¤æ˜“ç­†æ•¸: <strong>${trades.length}</strong></p>
        `;

        document.querySelector("#tradeTable tbody").innerHTML = trades.map((t, i) => 
            `<tr>
                <td>${t.date}</td>
                <td class="${t.action.includes('è²·') ? 'buy-text' : 'sell-text'}">${t.action}</td>
                <td>$${t.price.toFixed(2)}</td>
                <td>${t.shares}</td>
                <td class="${t.profit > 0 ? 'buy-text' : t.profit === 0 ? '' : 'sell-text'}">${t.profit ? `$${formatCurrency(t.profit)}` : '-'}</td>
            </tr>`).join('');

        if (chartInstance) chartInstance.destroy();
        const ctx = document.getElementById("mainChart").getContext("2d");
        const modeLabel = g_currentMode;
        chartInstance = new Chart(ctx, {
            type: "line",
            data: {
                labels: displayData.map(d => d.date),
                datasets: [
                    { label: 'å¯¦éš›è²·å…¥', data: displayData.map(d => trades.find(t => t.date === d.date && t.action === 'è²·å…¥') ? d.close : null), borderColor: '#27ae60', backgroundColor: '#27ae60', pointStyle: 'rectRot', pointRadius: 10, showLine: false, z: 10 },
                    { label: 'å¯¦éš›è³£å‡º/å¹³å€‰', data: displayData.map(d => trades.find(t => t.date === d.date && (t.action === 'è³£å‡º' || t.action === 'è³£å‡º(å¹³å€‰)')) ? d.close : null), borderColor: '#e74c3c', backgroundColor: '#e74c3c', pointStyle: 'rectRot', pointRadius: 10, showLine: false, z: 10 },
                    { label: 'é»ƒé‡‘äº¤å‰', data: displayData.map(d => {
                        const cross = allCrosses.find(c => c.date === d.date && c.type === 'gold');
                        return cross ? cross.val : null;
                    }), borderColor: '#f1c40f', pointStyle: 'circle', pointRadius: 5, showLine: false, z: 5 },
                    { label: 'æ­»äº¡äº¤å‰', data: displayData.map(d => {
                        const cross = allCrosses.find(c => c.date === d.date && c.type === 'death');
                        return cross ? cross.val : null;
                    }), borderColor: '#95a5a6', pointStyle: 'circle', pointRadius: 5, showLine: false, z: 5 },
                    { label: 'æ”¶ç›¤åƒ¹', data: displayData.map(d => d.close), borderColor: '#ddd', borderWidth: 1, pointRadius: 0, z: 1 },
                    { label: `${modeLabel} ${sVal}`, data: displayMS, borderColor: '#e74c3c', borderWidth: 2, pointRadius: 0, z: 2 },
                    { label: `${modeLabel} ${lVal}`, data: displayML, borderColor: '#3498db', borderWidth: 2, pointRadius: 0, z: 2 }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { usePointStyle: true } }
                }
            }
        });
    }

    function render2DChart() {
        const container = document.getElementById('scatter2dChart');
        
        const maxPeriod = Math.max(...g_allResults.map(r => Math.max(r.s, r.l)));
        const heatmapData = Array(maxPeriod).fill(0).map(() => Array(maxPeriod).fill(null));
        
        for (let r of g_allResults) {
            if (r.s <= maxPeriod && r.l <= maxPeriod) {
                heatmapData[r.l - 1][r.s - 1] = r.profit;
            }
        }

        const trace = {
            z: heatmapData,
            x: Array.from({length: maxPeriod}, (_, i) => i + 1),
            y: Array.from({length: maxPeriod}, (_, i) => i + 1),
            type: 'heatmap',
            colorscale: [
                [0, '#0000ff'],
                [0.167, '#0080ff'],
                [0.333, '#00ffff'],
                [0.5, '#00ff00'],
                [0.667, '#ffff00'],
                [0.833, '#ff8000'],
                [1, '#ff0000']
            ],
            hovertemplate: 'çŸ­æœŸ: %{x}<br>é•·æœŸ: %{y}<br>ç²åˆ©: $%{z:,.0f}<extra></extra>',
            showscale: true
        };

        const layout = {
            title: 'åƒæ•¸çµ„åˆç²åˆ©ç†±åŠ›åœ–',
            xaxis: { title: 'çŸ­æœŸå‡ç·šé€±æœŸ', showgrid: false },
            yaxis: { title: 'é•·æœŸå‡ç·šé€±æœŸ', showgrid: false },
            margin: { l: 80, r: 80, t: 60, b: 80 },
            font: { family: 'Segoe UI', size: 12 },
            hovermode: 'closest'
        };

        Plotly.newPlot(container, [trace], layout, { responsive: true, displayModeBar: true });
    }

    function render3DChart() {
        const container = document.getElementById('canvas3d');
        
        const maxPeriod = Math.max(...g_allResults.map(r => Math.max(r.s, r.l)));
        const surfaceData = Array(maxPeriod).fill(0).map(() => Array(maxPeriod).fill(null));
        
        for (let r of g_allResults) {
            if (r.s <= maxPeriod && r.l <= maxPeriod) {
                surfaceData[r.l - 1][r.s - 1] = r.profit;
            }
        }

        const trace = {
            z: surfaceData,
            x: Array.from({length: maxPeriod}, (_, i) => i + 1),
            y: Array.from({length: maxPeriod}, (_, i) => i + 1),
            type: 'surface',
            colorscale: [
                [0, '#0000ff'],
                [0.167, '#0080ff'],
                [0.333, '#00ffff'],
                [0.5, '#00ff00'],
                [0.667, '#ffff00'],
                [0.833, '#ff8000'],
                [1, '#ff0000']
            ],
            hovertemplate: 'çŸ­æœŸ: %{x}<br>é•·æœŸ: %{y}<br>ç²åˆ©: $%{z:,.0f}<extra></extra>',
            showscale: true,
            opacity: 0.9
        };

        const layout = {
            title: '3D åƒæ•¸å„ªåŒ–ç©ºé–“',
            scene: {
                xaxis: { title: 'çŸ­æœŸé€±æœŸ' },
                yaxis: { title: 'é•·æœŸé€±æœŸ' },
                zaxis: { title: 'ç²åˆ© ($)' },
                aspectmode: 'auto',
                camera: {
                    eye: { x: 1.8, y: 1.8, z: 1.4 }
                }
            },
            margin: { l: 0, r: 0, t: 60, b: 0 },
            font: { family: 'Segoe UI', size: 12 },
            hovermode: 'closest'
        };

        Plotly.newPlot(container, [trace], layout, { responsive: true, displayModeBar: true });
    }

    async function runYearlyIntersection() {
        const btn = document.getElementById('yearlyBtn');
        g_initialCash = parseFloat(document.getElementById('initialCash').value);
        g_commission = parseFloat(document.getElementById('commission').value);
        const company = document.getElementById('companySelect').value;
        const yearStart = document.getElementById('yearStart').value;
        const yearEnd = document.getElementById('yearEnd').value;
        
        if (!window.csvRaw) return alert("è«‹å…ˆä¸Šå‚³ CSV");
        if (!yearStart || !yearEnd) return alert("è«‹é¸æ“‡åˆ†æçš„å¹´ä»½ç¯„åœ");
        if (yearStart > yearEnd) return alert("èµ·å§‹å¹´ä¸èƒ½å¤§æ–¼çµæŸå¹´");

        let data = window.csvRaw.map(r => ({ date: r[0], close: parseFloat(r[window.csvHeaders.indexOf(company)]) }))
                             .filter(d => !isNaN(d.close)).sort((a, b) => dateToInt(a.date) - dateToInt(b.date));

        // æŒ‰å¹´ä»½åˆ†çµ„æ•¸æ“šï¼Œä½†ä¿ç•™ç´¢å¼•ä¿¡æ¯
        const yearlyData = {};
        const yearlyIndices = {};  // è¨˜éŒ„æ¯å¹´æ•¸æ“šçš„èµ·æ­¢ç´¢å¼•
        data.forEach((d, idx) => {
            const year = d.date.includes('-') ? d.date.split('-')[0] : d.date.split('/')[2];
            if (!yearlyData[year]) {
                yearlyData[year] = [];
                yearlyIndices[year] = { start: idx, end: idx };
            }
            yearlyData[year].push(d);
            yearlyIndices[year].end = idx;
        });

        // æ ¹æ“šé¸æ“‡çš„å¹´ä»½ç¯„åœéæ¿¾
        let years = Object.keys(yearlyData).sort().filter(y => y >= yearStart && y <= yearEnd);
        
        if (years.length < 2) return alert("é¸æ“‡çš„å¹´ä»½ç¯„åœå…§è‡³å°‘éœ€è¦ 2 å¹´ä»¥ä¸Šçš„æ•¸æ“š");

        btn.disabled = true;
        document.getElementById('progWrapper').style.display = 'block';
        
        // å…ˆè¨ˆç®—æ•´å€‹æ•¸æ“šé›†çš„MAï¼ˆèˆ‡äº¤æ˜“æ˜ç´°ä¸€è‡´ï¼‰
        const computeFunc = g_currentMode === 'SMA' ? precomputeSMA : (g_currentMode === 'WMA' ? precomputeWMA : precomputeEMA);
        const allMA = {};
        for (let p = 1; p <= MAX_PERIOD; p++) allMA[p] = computeFunc(data, p);
        
        // è¨˜éŒ„æ¯å€‹åƒæ•¸åœ¨æ¯ä¸€å¹´çš„ç²åˆ©
        const paramProfits = {};  // {s_l: {year: profit, ...}, ...}
        const yearlyBestParams = {};
        
        for (let i = 0; i < years.length; i++) {
            const year = years[i];
            const { start: yearStartIdx, end: yearEndIdx } = yearlyIndices[year];
            document.getElementById('progLabel').innerText = `åˆ†æ ${year} å¹´ (${i+1}/${years.length})`;
            document.getElementById('progFill').style.width = ((i+1)/years.length*100) + "%";
            await new Promise(r => setTimeout(r, 10));

            // æ¸¬è©¦æ‰€æœ‰åƒæ•¸çµ„åˆï¼ˆä½¿ç”¨å®Œæ•´æ•¸æ“šçš„MAï¼Œåªåœ¨è©²å¹´ä»½ç¯„åœå…§å›æ¸¬ï¼‰
            const yearResults = [];
            for (let s = 1; s <= MAX_PERIOD; s++) {
                for (let l = 1; l <= MAX_PERIOD; l++) {
                    // ä½¿ç”¨äº¤æ˜“æ˜ç´°ç›¸åŒçš„ç®—æ³•ï¼šé€£çºŒå›æ¸¬ï¼Œä½†é™åˆ¶åœ¨è©²å¹´ä»½ç¯„åœ
                    const yearData = data.slice(yearStartIdx, yearEndIdx + 1);
                    const yearMaS = allMA[s].slice(yearStartIdx, yearEndIdx + 1);
                    const yearMaL = allMA[l].slice(yearStartIdx, yearEndIdx + 1);
                    const res = backtest(yearData, yearMaS, yearMaL, g_initialCash, 0, g_commission, false);
                    const profit = res.finalAsset - g_initialCash;
                    
                    const key = `${s}_${l}`;
                    if (!paramProfits[key]) paramProfits[key] = {};
                    paramProfits[key][year] = profit;
                    
                    yearResults.push({ s, l, profit, finalAsset: res.finalAsset });
                }
            }
            
            // æ‰¾è©²å¹´æœ€ä½³åƒæ•¸
            yearResults.sort((a, b) => b.finalAsset - a.finalAsset);
            yearlyBestParams[year] = yearResults[0];
        }

        // æ‰¾å‡ºåœ¨æ‰€æœ‰å¹´ä»½éƒ½æ²’è™§éŒ¢çš„åƒæ•¸çµ„åˆ
        const stableParams = [];
        for (const [key, profits] of Object.entries(paramProfits)) {
            const [s, l] = key.split('_').map(Number);
            const profitsArray = Object.values(profits);
            
            // æª¢æŸ¥æ‰€æœ‰å¹´ä»½éƒ½æœ‰æ•¸æ“šä¸”éƒ½æ²’è™§éŒ¢
            if (Object.keys(profits).length === years.length && profitsArray.every(p => p >= 0)) {
                const avgProfit = profitsArray.reduce((a, b) => a + b, 0) / profitsArray.length;
                const totalProfit = profitsArray.reduce((a, b) => a + b, 0);
                stableParams.push({
                    s, l, key,
                    avgProfit,
                    totalProfit,
                    profits: Object.fromEntries(Object.entries(profits).map(([yr, pft]) => [yr, pft]))
                });
            }
        }

        stableParams.sort((a, b) => b.avgProfit - a.avgProfit);

        // é¡¯ç¤ºå¹´ä»½çµ±è¨ˆå¡ç‰‡
        const yearlyGrid = document.getElementById('yearlyGrid');
        yearlyGrid.innerHTML = '';
        for (const year of years) {
            const best = yearlyBestParams[year];
            
            const card = document.createElement('div');
            card.className = 'yearly-card';
            card.innerHTML = `
                <h4>${year} å¹´</h4>
                <p>ç©©å®šåƒæ•¸æ•¸é‡: <strong>${Object.values(paramProfits).filter(p => p[year] >= 0).length}</strong></p>
                <p>æœ€ä½³ç²åˆ©: <strong style="color: var(--success);">$${formatCurrency(best.finalAsset - g_initialCash)}</strong></p>
                <p>æœ€ä½³åƒæ•¸: <span style="color: var(--accent); font-weight: bold;">${best.s}/${best.l}</span></p>
            `;
            yearlyGrid.appendChild(card);
        }

        // ç”Ÿæˆåƒæ•¸ç©©å®šæ€§ç†±åŠ›åœ– (Plotly)
        const topStableParams = stableParams.slice(0, 100);  // é¡¯ç¤º top 100 ç©©å®šåƒæ•¸
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ç©©å®šåƒæ•¸
        if (topStableParams.length === 0) {
            alert('âŒ æœªæ‰¾åˆ°åœ¨æ‰€æœ‰å¹´ä»½éƒ½æ²’è™§éŒ¢çš„åƒæ•¸çµ„åˆ\n\nå¯èƒ½åŸå› ï¼š\n1. æ•¸æ“šè·¨åº¦ä¸è¶³\n2. æ‰‹çºŒè²»è¨­ç½®éé«˜\n3. åˆå§‹è³‡é‡‘ä¸è¶³\n\nè«‹å˜—è©¦ï¼š\n- èª¿æ•´æ‰‹çºŒè²»\n- æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§');
            btn.disabled = false;
            document.getElementById('progWrapper').style.display = 'none';
            return;
        }
        
        const heatmapData = topStableParams.map(p => years.map(yr => p.profits[yr]));
        const paramLabels = topStableParams.map(p => `${p.s}/${p.l}`);

        const trace = {
            z: heatmapData,
            x: years,
            y: paramLabels,
            type: 'heatmap',
            colorscale: [
                [0, '#0000ff'],
                [0.167, '#0080ff'],
                [0.333, '#00ffff'],
                [0.5, '#00ff00'],
                [0.667, '#ffff00'],
                [0.833, '#ff8800'],
                [1, '#ff0000']
            ],
            hovertemplate: 'åƒæ•¸: %{y}<br>å¹´ä»½: %{x}<br>ç²åˆ©: $%{z:,.0f}<extra></extra>',
            showscale: true,
            colorbar: {
                title: 'ç²åˆ© ($)',
                thickness: 20,
                len: 0.7
            }
        };

        const layout = {
            title: `æ‰€æœ‰å¹´ä»½éƒ½æ²’è™§éŒ¢çš„åƒæ•¸ç©©å®šæ€§ç†±åŠ›åœ– (å…± ${stableParams.length} å€‹)`,
            xaxis: { title: 'å¹´ä»½', side: 'bottom' },
            yaxis: { title: 'åƒæ•¸çµ„åˆ (çŸ­æœŸ/é•·æœŸ)', automargin: true },
            height: Math.max(500, 25 * Math.min(topStableParams.length, 100)),
            width: Math.max(800, 100 + 80 * years.length),
            margin: { l: 120, r: 100, t: 80, b: 100 },
            font: { family: 'Segoe UI', size: 11 },
            hovermode: 'closest',
            paper_bgcolor: '#f8f9fa',
            plot_bgcolor: 'white'
        };

        Plotly.newPlot(document.getElementById('stabilityHeatmap'), [trace], layout, { responsive: true, displayModeBar: true });

        // ç‚ºç†±åŠ›åœ–æ·»åŠ é»æ“Šäº‹ä»¶ - é»æ“Šåƒæ•¸å¯æŸ¥çœ‹è©³æƒ…
        document.getElementById('stabilityHeatmap').on('plotly_click', function(data) {
            if (data.points.length > 0) {
                const point = data.points[0];
                const paramIdx = point.pointNumber[0];
                const param = topStableParams[paramIdx];
                if (param) {
                    showSpecificResult(param.s, param.l, 1);
                }
            }
        });

        // é¡¯ç¤º Top 10 æœ€ç©©å®šåƒæ•¸
        const stableParamsList = document.getElementById('stableParamsList');
        stableParamsList.innerHTML = stableParams.slice(0, 10).map((p, i) => {
            const minProfit = Math.min(...Object.values(p.profits));
            const maxProfit = Math.max(...Object.values(p.profits));
            const profitVariance = ((maxProfit - minProfit) / p.avgProfit * 100).toFixed(1);
            
            return `
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--accent); border-radius: 6px; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);" 
                 onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
                 onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'"
                 onclick="showSpecificResult(${p.s}, ${p.l}, 1)">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <strong style="font-size: 15px; color: var(--primary);">ğŸ† æ’å #${i+1}: åƒæ•¸ <span style="color: var(--accent); font-size: 16px;">${p.s}/${p.l}</span></strong>
                    <span style="background: var(--success); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold;">æœ€ç©©å®š</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                    <div>
                        <p style="margin: 4px 0; color: #666;">ğŸ“Š å¹³å‡å¹´ç²åˆ©</p>
                        <p style="margin: 4px 0; color: var(--success); font-weight: bold; font-size: 14px;">$${formatCurrency(p.avgProfit)}</p>
                    </div>
                    <div>
                        <p style="margin: 4px 0; color: #666;">ğŸ’° ç¸½ç²åˆ© (${years.length}å¹´)</p>
                        <p style="margin: 4px 0; color: var(--accent); font-weight: bold; font-size: 14px;">$${formatCurrency(p.totalProfit)}</p>
                    </div>
                    <div>
                        <p style="margin: 4px 0; color: #666;">ğŸ“ˆ ç²åˆ©æ³¢å‹•åº¦</p>
                        <p style="margin: 4px 0; color: #e67e22; font-weight: bold;">Â±${profitVariance}%</p>
                    </div>
                    <div>
                        <p style="margin: 4px 0; color: #666;">âœ… ç©©å®šæ€§</p>
                        <p style="margin: 4px 0; color: var(--success); font-weight: bold;">${years.length}/${years.length} å¹´</p>
                    </div>
                </div>
                <p style="margin: 8px 0 0 0; font-size: 12px; color: #999; border-top: 1px solid #eee; padding-top: 8px;">
                    å„å¹´ç²åˆ©: ${years.map(yr => `<span style="display: inline-block; margin-right: 15px; width: 130px;"><strong>${yr}:</strong> <span style="font-family: 'Courier New', monospace; color: ${p.profits[yr] >= 0 ? '#27ae60' : '#e74c3c'}; text-align: right; display: inline-block; width: 85px;">$${formatCurrency(p.profits[yr])}</span></span>`).join('')}
                </p>
            </div>
        `}).join('');

        document.getElementById('stabilitySection').classList.add('show');
        document.getElementById('yearlyResults').classList.remove('show');
        
        btn.disabled = false;
        document.getElementById('progWrapper').style.display = 'none';
        
        // è©³ç´°çš„å®Œæˆæç¤º
        const bestParam = stableParams[0];
        const minProfit = Math.min(...Object.values(bestParam.profits));
        const maxProfit = Math.max(...Object.values(bestParam.profits));
        alert(`âœ¨ åˆ†æå®Œæˆï¼

ğŸ“Š çµ±è¨ˆçµæœï¼š
â€¢ æ‰¾åˆ° ${stableParams.length} å€‹åœ¨æ‰€æœ‰å¹´ä»½éƒ½æ²’è™§éŒ¢çš„åƒæ•¸çµ„åˆ
â€¢ è·¨è¶Šå¹´ä»½ï¼š${years.length} å¹´ (${years[0]} ~ ${years[years.length-1]})

ğŸ† æœ€ä½³åƒæ•¸ï¼š${bestParam.s}/${bestParam.l}
â€¢ å¹³å‡å¹´ç²åˆ©ï¼š$${formatCurrency(bestParam.avgProfit)}
â€¢ ç¸½ç²åˆ©ï¼š$${formatCurrency(bestParam.totalProfit)}
â€¢ æœ€é«˜å¹´ç²åˆ©ï¼š$${formatCurrency(maxProfit)} (${Object.entries(bestParam.profits).find(([_, p]) => p === maxProfit)[0]} å¹´)
â€¢ æœ€ä½å¹´ç²åˆ©ï¼š$${formatCurrency(minProfit)} (${Object.entries(bestParam.profits).find(([_, p]) => p === minProfit)[0]} å¹´)

ğŸ’¡ æç¤ºï¼šé»æ“Šä»»ä½•åƒæ•¸å¯æŸ¥çœ‹è©²çµ„åˆçš„è©³ç´°å›æ¸¬çµæœå’Œèµ°å‹¢åœ–`);
    }
</script>

</body>
</html>
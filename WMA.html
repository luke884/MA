<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>WMA å°ˆæ¥­å›æ¸¬ç³»çµ± </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .input-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { grid-column: span 2; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #2980b9; }
        
        .progress-wrapper { display: none; margin: 20px 0; }
        .progress-bar { height: 12px; background: #eee; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.1s; }
        
        .results-grid { display: grid; grid-template-columns: 400px 1fr; gap: 20px; margin-top: 30px; }
        .side-panel { display: flex; flex-direction: column; gap: 20px; }
        .stats-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 5px solid var(--accent); }
        
        .rank-table-wrapper { max-height: 550px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
        th { background: #f8f9fa; position: sticky; top: 0; z-index: 1; }

        #topTable tbody tr { cursor: pointer; transition: 0.2s; }
        #topTable tbody tr:hover { background: #e3f2fd; }
        #topTable tbody tr.selected { background: #bbdefb; font-weight: bold; }

        .trade-table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; }
        .buy-text { color: var(--success); font-weight: bold; }
        .sell-text { color: var(--danger); font-weight: bold; }
        .final-text { color: #e74c3c; font-weight: bold; font-style: italic; }
        
        #chartContainer { width: 100%; height: 550px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>WMA å‡ç·šå›æ¸¬ç³»çµ± </h1>

    <div class="input-section">
        <div class="input-group"><label>åˆå§‹è³‡é‡‘</label><input id="initialCash" type="number" value="10000"></div>
        <div class="input-group"><label>é¸æ“‡å…¬å¸</label><select id="companySelect"><option>è«‹å…ˆä¸Šå‚³ CSV</option></select></div>
        <div class="input-group"><label>èµ·å§‹æ—¥æœŸ</label><input id="startDate" type="date" value="2024-01-01"></div>
        <div class="input-group"><label>çµæŸæ—¥æœŸ</label><input id="endDate" type="date" value="2024-12-31"></div>
        <div class="input-group" style="grid-column: span 2;"><label>ä¸Šå‚³ CSV æª”æ¡ˆ</label><input id="csvFile" type="file" accept=".csv"></div>
        <button id="runBtn" onclick="runOptimization()">é–‹å§‹å…¨åƒæ•¸æœ€ä½³åŒ–</button>
    </div>

    <div class="progress-wrapper" id="progWrapper">
        <label id="progLabel">è¨ˆç®—é€²åº¦...</label>
        <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>
    </div>

    <div class="results-grid">
        <div class="side-panel">
            <div id="bestResult" class="stats-card">å°šæœªåŸ·è¡Œ</div>
            <h3>ğŸ† æ’è¡Œæ¦œ (Top 20)</h3>
            <div class="rank-table-wrapper">
                <table id="topTable">
                    <thead><tr><th>æ’å</th><th>çŸ­/é•·</th><th>æœ€çµ‚è³‡ç”¢</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div>
            <div id="chartContainer"><canvas id="mainChart"></canvas></div>
            <h3 id="tableTitle">ğŸ“‘ äº¤æ˜“æ˜ç´° </h3>
            <div class="trade-table-wrapper">
                <table id="tradeTable">
                    <thead><tr><th>æ—¥æœŸ</th><th>å‹•ä½œ</th><th>åƒ¹æ ¼</th><th>è‚¡æ•¸</th><th>ç²åˆ©</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let g_backtestData = [], g_allWma = {}, g_startIdx = 0, g_initialCash = 0, chartInstance = null;
    const MAX_PERIOD = 256;


    function formatCurrency(num) {
        return num.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
    }

    function dateToInt(dStr) {
        if (!dStr) return 0;
        const parts = dStr.includes('-') ? dStr.split('-') : dStr.split('/');
        if (parts.length !== 3) return 0;
        const [y, m, d] = dStr.includes('-') ? parts : [parts[2], parts[0], parts[1]];
        return parseInt(y + m.padStart(2, '0') + d.padStart(2, '0'));
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const lines = event.target.result.trim().split("\n");
            window.csvHeaders = lines[0].split(",").map(h => h.trim());
            window.csvRaw = lines.slice(1).map(line => line.split(","));
            document.getElementById("companySelect").innerHTML = window.csvHeaders.slice(1).map(h => `<option value="${h}">${h}</option>`).join('');
        };
        reader.readAsText(e.target.files[0]);
    });

    function precomputeWMA(data, period) {
        let wma = [];
        for (let i = 0; i < data.length; i++) {
            if (i < period - 1) {
                wma.push(null);
            } else {
                let sum = 0, weightSum = 0;
                for (let j = 0; j < period; j++) {
                    let weight = j + 1;
                    sum += data[i - period + j].close * weight;  // ä¿®æ­£ç´¢å¼•
                    weightSum += weight;
                }
                wma.push(sum / weightSum);
            }
        }
        return wma;
    }

    function backtest(data, wmaS, wmaL, initialCash, startIdx, recordTrades = false) {
        let cash = initialCash, shares = 0, distCap = 0, hasPos = false;
        let maxValue = initialCash, maxDD = 0, trades = [], allCrosses = [];

        for (let i = startIdx; i < data.length; i++) {
            const price = data[i].close;
            const isLastDay = (i === data.length - 1);
            
            if (i > 0 && wmaS[i-1] !== null && wmaL[i-1] !== null) {
                // æ¨™è¨»é‡‘å‰ (äº¤å‰é»å®šç‚ºå…©æ¢å‡ç·šçš„å¹³å‡å€¼ï¼Œæˆ–æ˜¯ wmaS ç•¶å‰å€¼ï¼Œèƒ½ç²¾ç¢ºè½åœ¨ç·šä¸Š)
                if (wmaS[i-1] < wmaL[i-1] && wmaS[i] >= wmaL[i]) {
                    allCrosses.push({ date: data[i].date, type: 'gold', val: wmaS[i] });
                    if (!hasPos && !isLastDay) {
                        shares = Math.floor(cash / price);
                        if (shares > 0) {
                            distCap = cash; cash -= (shares * price); hasPos = true;
                            if (recordTrades) trades.push({ date: data[i].date, action: 'è²·å…¥', price, shares });
                        }
                    }
                } 
                // æ¨™è¨»æ­»å‰
                else if (wmaS[i-1] > wmaL[i-1] && wmaS[i] <= wmaL[i]) {
                    allCrosses.push({ date: data[i].date, type: 'death', val: wmaS[i] });
                    if (hasPos) {
                        let sellVal = shares * price;
                        if (recordTrades) trades.push({ date: data[i].date, action: 'è³£å‡º', price, shares, profit: (cash + sellVal) - distCap });
                        cash += sellVal; shares = 0; hasPos = false;
                    }
                }
            }
            
            if (hasPos && isLastDay) {
                let sellVal = shares * price;
                if (recordTrades) trades.push({ date: data[i].date, action: 'è³£å‡º(å¹³å€‰)', price, shares, profit: (cash + sellVal) - distCap });
                cash += sellVal; shares = 0; hasPos = false;
            }
            let currentVal = cash + (shares * price);
            maxValue = Math.max(maxValue, currentVal);
            maxDD = Math.max(maxDD, (maxValue - currentVal) / maxValue);
        }
        return { finalAsset: cash, maxDD: maxDD * 100, trades, allCrosses };
    }

    async function runOptimization() {
        const btn = document.getElementById('runBtn');
        g_initialCash = parseFloat(document.getElementById('initialCash').value);
        const company = document.getElementById('companySelect').value;
        const sInt = dateToInt(document.getElementById('startDate').value);
        const eInt = dateToInt(document.getElementById('endDate').value);
        
        if (!window.csvRaw) return alert("è«‹å…ˆä¸Šå‚³ CSV");

        let data = window.csvRaw.map(r => ({ date: r[0], close: parseFloat(r[window.csvHeaders.indexOf(company)]) }))
                             .filter(d => !isNaN(d.close)).sort((a, b) => dateToInt(a.date) - dateToInt(b.date));
        g_startIdx = data.findIndex(d => dateToInt(d.date) >= sInt);
        const endIdx = data.findLastIndex(d => dateToInt(d.date) <= eInt);
        g_backtestData = data.slice(0, endIdx + 1);

        btn.disabled = true; document.getElementById('progWrapper').style.display = 'block';
        g_allWma = {};
        for (let p = 1; p <= MAX_PERIOD; p++) g_allWma[p] = precomputeWMA(g_backtestData, p);

        let results = [];
        for (let s = 1; s <= MAX_PERIOD; s++) {
            if (s % 16 === 0) {
                document.getElementById('progFill').style.width = (s/MAX_PERIOD*100) + "%";
                await new Promise(r => setTimeout(r, 0));
            }
            for (let l = 1; l <= MAX_PERIOD; l++) {
                let res = backtest(g_backtestData, g_allWma[s], g_allWma[l], g_initialCash, g_startIdx);
                results.push({ s, l, ...res });
            }
        }


        results.sort((a, b) => {
            if (Math.abs(a.finalAsset - b.finalAsset) > 0.01) return b.finalAsset - a.finalAsset;
            let diffA = Math.abs(a.s - a.l), diffB = Math.abs(b.s - b.l);
            if (diffA !== diffB) return diffB - diffA; 
            if (a.s !== b.s) return a.s - b.s;
            return a.l - b.l;
        });

        updateRankTable(results.slice(0, 20)); 
        showSpecificResult(results[0].s, results[0].l, 1);
        btn.disabled = false; document.getElementById('progWrapper').style.display = 'none';
    }

    function updateRankTable(top) {
        document.querySelector("#topTable tbody").innerHTML = top.map((r, i) => 
            `<tr onclick="showSpecificResult(${r.s}, ${r.l}, ${i+1}, this)">
                <td>${i+1}</td><td>${r.s}/${r.l}</td><td>$${formatCurrency(r.finalAsset)}</td>
            </tr>`).join('');
    }

    function showSpecificResult(s, l, rank, element = null) {
        if (element) {
            document.querySelectorAll('#topTable tbody tr').forEach(tr => tr.classList.remove('selected'));
            element.classList.add('selected');
        }
        const detailed = backtest(g_backtestData, g_allWma[s], g_allWma[l], g_initialCash, g_startIdx, true);
        document.getElementById('bestResult').innerHTML = `
            <h3>â­ çµ„åˆ: ${s}/${l} (Rank ${rank})</h3>
            <p>æœ€çµ‚è³‡ç”¢: $${formatCurrency(detailed.finalAsset)}</p>
            <p>æœ€å¤§å›æ’¤: ${detailed.maxDD.toFixed(2)}%</p>
        `;
        document.querySelector("#tradeTable tbody").innerHTML = detailed.trades.map(t => `
            <tr>
                <td>${t.date}</td>
                <td class="${t.action==='è²·å…¥'?'buy-text':(t.action==='è³£å‡º(å¹³å€‰)'?'final-text':'sell-text')}">${t.action}</td>
                <td>$${t.price}</td><td>${t.shares}</td>
                <td>${t.profit ? '$' + formatCurrency(t.profit) : '-'}</td>
            </tr>
        `).join('');
        renderChart(g_backtestData.slice(g_startIdx), g_allWma[s].slice(g_startIdx), g_allWma[l].slice(g_startIdx), detailed.trades, detailed.allCrosses, s, l);
    }

    function renderChart(data, wS, wL, trades, allCrosses, sVal, lVal) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [
                    { label: 'å¯¦éš›è²·å…¥', data: data.map(d => trades.find(t => t.date === d.date && t.action === 'è²·å…¥') ? d.close : null), borderColor: '#27ae60', backgroundColor: '#27ae60', pointStyle: 'triangle', pointRadius: 10, showLine: false, z: 10 },
                    { label: 'å¯¦éš›è³£å‡º/å¹³å€‰', data: data.map(d => trades.find(t => t.date === d.date && (t.action === 'è³£å‡º' || t.action === 'è³£å‡º(å¹³å€‰)')) ? d.close : null), borderColor: '#e74c3c', backgroundColor: '#e74c3c', pointStyle: 'rectRot', pointRadius: 10, showLine: false, z: 10 },
                    { label: 'é»ƒé‡‘äº¤å‰', data: data.map(d => {
                        const cross = allCrosses.find(c => c.date === d.date && c.type === 'gold');
                        return cross ? cross.val : null;
                    }), borderColor: '#f1c40f', pointStyle: 'circle', pointRadius: 5, showLine: false, z: 5 },
                    { label: 'æ­»äº¡äº¤å‰', data: data.map(d => {
                        const cross = allCrosses.find(c => c.date === d.date && c.type === 'death');
                        return cross ? cross.val : null;
                    }), borderColor: '#95a5a6', pointStyle: 'circle', pointRadius: 5, showLine: false, z: 5 },
                    { label: 'æ”¶ç›¤åƒ¹', data: data.map(d => d.close), borderColor: '#ddd', borderWidth: 1, pointRadius: 0, z: 1 },
                    { label: `WMA ${sVal}`, data: wS, borderColor: '#e74c3c', borderWidth: 2, pointRadius: 0, z: 2 },
                    { label: `WMA ${lVal}`, data: wL, borderColor: '#3498db', borderWidth: 2, pointRadius: 0, z: 2 }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { usePointStyle: true } }
                }
            }
        });
    }
</script>
</body>
</html>